{"version":3,"sources":["../../../../src/db/graphql/resolvers/requestAddTeamMember.js"],"names":["executeRequestAddTeamMember","nonce","url","targetUser","teamName","session","Session","findOne","where","err","response","user","getUser","teams","getTeams","team","filter","name","active","newTeamMember","User","email","activationNonce","generate","addUser","through","type","confirmUrl","returnResponse","to","from","subject","content","firstName","lastName","sendMail","console","error","message","requestAddTeamMember","_","args","context","log"],"mappings":";;;;;;;;;;AAAA;;;;AACA;;AACA;;;;;;AAEA,MAAMA;AAAA,6CAA8B,WAAO,EAAEC,KAAF,EAASC,GAAT,EAAcC,UAAd,EAA0BC,QAA1B,EAAP,EAAgD;AAClF,QAAI;AACF,YAAMC,UAAW,MAAM,wBAAGC,OAAH,CAAWC,OAAX,CAAmB,EAAEC,OAAO,EAAEP,KAAF,EAAT,EAAnB,CAAvB;AACA,UAAG,CAACI,OAAJ,EAAa;AAAE,eAAO,EAAEI,KAAK,IAAP,EAAaC,UAAU,+BAAvB,EAAP;AAAiE;AAChF,YAAMC,OAAO,MAAMN,QAAQO,OAAR,EAAnB;AACA,UAAG,CAACD,IAAJ,EAAU;AAAE,eAAO,EAAEF,KAAK,IAAP,EAAaC,UAAU,+BAAvB,EAAP;AAAiE;AAC7E,YAAMG,QAAQ,MAAMF,KAAKG,QAAL,EAApB;AACA,YAAMC,OAAOF,MAAMG,MAAN,CAAa,UAACD,IAAD;AAAA,eAAWA,KAAKE,IAAL,IAAab,QAAxB;AAAA,OAAb,EAAgD,CAAhD,CAAb;AACA,UAAGW,KAAKG,MAAL,IAAe,KAAlB,EAAyB;AAAE,eAAO,EAAET,KAAK,IAAP,EAAaC,UAAU,qBAAvB,EAAP;AAAuD;AAClF,YAAMS,gBAAgB,MAAM,wBAAGC,IAAH,CAAQb,OAAR,CAAgB,EAAEC,OAAO,EAACa,OAAOlB,UAAR,EAAT,EAAhB,CAA5B;AACA,UAAG,CAACgB,aAAJ,EAAmB;AAAE,eAAO,EAAEV,KAAK,IAAP,EAAaC,UAAU,oCAAvB,EAAP;AAAsE;AAC3F,YAAMY,kBAAkB,kBAAQC,QAAR,EAAxB;AACAR,WAAKS,OAAL,CAAaL,aAAb,EAA4B,EAAEM,SAAS,EAAEC,MAAM,QAAR,EAAkBJ,eAAlB,EAAX,EAA5B;AACA,YAAMK,aAAazB,MAAO,YAAWD,KAAM,EAA3C;AACA,YAAM2B,iBAAkB,sBAAqBzB,UAAW,OAAMC,QAAS,wDAAvE;AACA,YAAMiB,QAAQ;AACZQ,YAAI1B,UADQ;AAEZ2B,cAAM,iBAFM;AAGZC,iBAAU,QAAO3B,QAAS,WAHd;AAIZ4B,iBAAU,GAAErB,KAAKsB,SAAU,IAAGtB,KAAKuB,QAAS,uCAAsC9B,QAAS,kCAAiCuB,UAAW,0BAJ3H;AAKZD,cAAM;AALM,OAAd;AAOA,aAAO,MAAM,wBAAWS,QAAX,CAAoBP,cAApB,EAAoCP,KAApC,CAAb;AACD,KAtBD,CAsBE,OAAMZ,GAAN,EAAW;AACX2B,cAAQC,KAAR,CAAc5B,GAAd;AACA,aAAO,EAAEA,KAAK,IAAP,EAAaC,UAAUD,IAAI6B,OAA3B,EAAP;AACD;AACF,GA3BK;;AAAA;AAAA;AAAA;AAAA,IAAN;;AA6BA,MAAMC,uBAAuB,CAACC,CAAD,EAAIC,IAAJ,EAAUC,OAAV,KAAsB;AACjDN,UAAQO,GAAR,CAAY,eAAZ;AACA,SAAO3C,4BAA4ByC,IAA5B,CAAP;AACD,CAHD;;kBAKeF,oB","file":"requestAddTeamMember.js","sourcesContent":["import db from '../../sequelize/models/db_connection'\nimport { mailClient } from '../../../lib/mail_client'\nimport shortId from 'shortid'\n\nconst executeRequestAddTeamMember = async ({ nonce, url, targetUser, teamName }) => {\n  try {\n    const session =  await db.Session.findOne({ where: { nonce } })\n    if(!session) { return { err: true, response: 'Whoops! Something went wrong.' } }\n    const user = await session.getUser()\n    if(!user) { return { err: true, response: 'Whoops! Something went wrong.' } }\n    const teams = await user.getTeams()\n    const team = teams.filter((team) => (team.name == teamName))[0]\n    if(team.active == false) { return { err: true, response: 'Team is not active!' } }\n    const newTeamMember = await db.User.findOne({ where: {email: targetUser} })\n    if(!newTeamMember) { return { err: true, response: 'Can\\'t find a user with that email' } }\n    const activationNonce = shortId.generate()\n    team.addUser(newTeamMember, { through: { type: \"MEMBER\", activationNonce } })\n    const confirmUrl = url + `?confirm=${nonce}`\n    const returnResponse = `The request to add ${targetUser} to ${teamName} has been sent! Please tell them to check their email.`\n    const email = {\n      to: targetUser,\n      from: 'aura@pibrain.io',\n      subject: `Join ${teamName} on Aura!`,\n      content: `${user.firstName} ${user.lastName} has invited you to join their team ${teamName} on Aura! Please click <a href=${confirmUrl}> here to join the team.`,\n      type: 'auraTeamMemberRequest',\n    }\n    return await mailClient.sendMail(returnResponse, email)\n  } catch(err) {\n    console.error(err)\n    return { err: true, response: err.message }\n  }\n}\n\nconst requestAddTeamMember = (_, args, context) => {\n  console.log('addTeamMember')\n  return executeRequestAddTeamMember(args)\n}\n\nexport default requestAddTeamMember\n"]}